name: Update News (every 15m)

on:
  schedule:
    - cron: "*/15 * * * *"        # 每小时的 00/15/30/45
    - cron: "7-59/15 * * * *"     # 每小时的 07/22/37/52，兜底执行，减少抖动
  workflow_dispatch:

concurrency:
  group: "news-update"
  cancel-in-progress: true

jobs:
  update-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # 确保可以提交代码
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install feedparser

      - name: Run News Aggregator
        run: |
          python scripts/aggregator.py
          date +%s > .last_run   # 更新心跳时间戳，强制触发提交

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add news.json .last_run
          git commit -m "chore: update news.json (auto)" || echo "No changes to commit"
          git pull --rebase origin main || true
          git push origin main || echo "Push failed, possibly no changes"
